# Готовое решение

# https://mos-knigi.volkv.com

## Stack

* Laravel `8.54`
* PostgreSQL `14`
* Nginx `1.21.3`
* Redis `6.2.6`
* Meilisearch `0.23.0`
* React `16.14`

## Технологии

* Docker / Compose
* Очереди Redis
* Коллаборативная фильтрация
* Кэш Redis
* Планировщик Laravel
* Meilisearch - современный, эффективный поиск на языке Rust

## Полная документация к API:

> https://mos-knigi.volkv.com/api

## Методы API

#### Список рекомендаций для пользователя

> GET /api/v1/recs_for_user_id/{userId}
>

#### Список ближайших соседей для пользователя

> GET /api/v1/neighbours_for_user_id/{userId}

#### История книг пользователя

> GET /api/v1/history_for_user_id/{userId}

#### Поиск по книгам

> GET /api/v1/search?q={query}
>

## Функционал веб-интерфейса:

* Выдача рекомендаций по заданному `userID`
* Поиск ближайших соседей `userID` и отображением их книг (общих и различных)
* Поиск по всем книгам на сайте

## Техническая реализация:

* Был проведен рефакторинг и очистка данных. Книги с одинаковым содержанием были объединены в абстрактные уникальные книги. Для работы любой
  рекомендательной системы, в т.ч. основанной на коллаборативной фильтрации необходимы качественные данные на входе, поэтому мы отрефакторили и
  нормализовали все данные из датасета в удобную структуру.

<img width="500" src="https://i.imgur.com/SItPqet.png" alt="">

* Машинное обучение необходимо тогда, когда мы не понимаем как устроена задача и не знаем как её решить обычными средствами. И вместо того, чтобы
  пытаться решить мы стараемся угадать вероятность того или иного решения. Команда Киборги понимает как устроена задача.
* Нам был использован алгоритм коллаборативной фильтрации на движке PostreSQL. Модель на основе коллаборативной фильтрации показала самые лучшие
  результаты. С помощью конструкций Join и вложенных запросов мы смогли добиться высокой точности и производительности.
  <img width="250" src="https://i.imgur.com/7aUHHIM.png" alt="">
* Алгоритм можно описать следующим образом - по списку книг пользователя мы ищем его соседей (сосед - читатель со схожим книжным вкусом). Фактор
  совпадения - это усредненный показатель кол-ва совпадений и процента от общего кол-ва книг соседа. Таким образом, мы получаем 10 ближайших соседей,
  после чего мы получаем списки их книг и сортируем по взвешенному показателю (`score`), который рассчитывается по тому, сколько раз встречается книга
  у соседа и по тому, насколько сосед релевантен. Это усреднение позволяет нам избежать ситуации, когда популярная книга часто встречается у далеких
  соседей. Наша модель в таком случае предложит более редкую книгу, но из списка соседа с более близким вкусом, что, скорее всего будет более
  релевантно пользователю.
* Скорость работы модели для холодной выдачи рекомендации из 10 книг для 1 пользователя составляет ~`300мс` (i5-9400) (происходит анализ более 10млн
  записей о циркуляциях книг). Возможна дальнейшая оптимизация алгоритма.
* Переобучение не требуется. Модель всегда находится в актуальном состоянии.
* Возможно пассивное (ленивое) составление рекомендаци и кэширование их для пользователей. В таком случае, пользователи смогут получать рекомендации
  моментально и без нагрузки на ресурсы сервера.
* Простота поддержи и настройки. Возможно моментально скорректировать работу модели с помощью изменения основных констант в коде - (кол-ва соседей,
  формула рассчета фактора, `score` и прочее). Решение без машинного обучение, нейросетей и AI - сильно упрощает систему. Возможно разобраться в
  модели без специальных знаний в области ML/DS. Работа модели более прозрачна и предсказуемма. Эффективность рекомендаций коллаборативной фильтрации,
  по нашим данным, выше, чем аналогичные ML решения.

## Планы развития

* Для составления максимально релевантных рекомендаций необходимо получить информацию не только о том, какие книги пользователь брал в библиотеках, а
  о том, понравилась ли ему та или иная книга. Это сильно улучшит результаты рекомендательной системы. Данные о том, понравилась ли пользователю книга
  можно собирать различными способами:

* В библиотеке при сдаче книги, работник библиотеки может получать обратную связь от читателя и заводить оценку в систему.
* На сайте mos.ru/knigi пользователь может иметь возможность оценить книги, которые он брал/читал.

* Если у пользователя будет возможность создавать свои подборки (коллекции) книг в веб-интерфейсе (напр. Детективы, Лучшее, Для развития и т.п.), то
  это, так же, улучшит качество рекомендаций. Мы сможем рекомендовать книги непосредственно для каждого списка, эти рекомендации будут более точны. Публичные подборки
* Возможность добавить элементы соц.сети - отображать ближайших соседей пользователя и возможность связаться с ними. Это люди с близким книжным
  вкусом, и, возможно, интересами. Будет здорово если они познакомятся.
* Бонусом мы решили создать прототип идеального веб-интерфейса для Библиотек Москвы. Мы вдохновлялись лучшими практиками музыкальных стриминговых
  сервисов, т.к. у нас схожие задачи - рекомендовать контент.
* Новый современный дизайн и функционал крутых рекомендаций на новом сайте вызовут эффект сарафанного радио и повысят посещаемость библиотек.
* VK.Books - MiniApp внутри соц сети с рекомендациями и списками книг пользователей (по аналогии с музыкой)

## Локальный запуск (Linux / macOS):

##### Local SSL (https://github.com/FiloSottile/mkcert) (необязательно)

> `mkcert -key-file key.pem -cert-file cert.pem libraries.local && mv -t docker/nginx/local/ssl/ key.pem cert.pem` - для того, чтобы сайт открывался по https с действительным сертификатом

##### /etc/hosts

> `127.0.0.1  libraries.local` - добавляем наш тестовый локальный домен

##### Зависимости

* git (`apt install git`)
* make (`apt install make`)
* docker / docker-compose (`apt install docker-compose`)

### Git clone

> `git clone git@github.com:volkv/leaders2021-hack-case-03-libraries.git`

> `cd leaders2021-hack-case-03-libraries`

# Сборка

> `cp .env.example .env` - скопировать файл с переменным окружения

> `make docker-build` - сборка Docker контейнеров

> `make setup-local` - установка зависимостей, сборка фронта

### Восстановление БД PostgreSQL с очищенными данными

> `https://mos-knigi.volkv.com/storage/backup` - скачать дамп PostgreSQL в папку ./docker/sql/

> `make restore-sql` - команда восстановления дампа БД

### Успех. Сервер запущен и доступен по адресу: https://libraries.local:8080

### Использование

> `make npm-watch` - сборка фронта в режиме watch

> `make cache` - очистка кэша приложения

> `make search` - принудительно обновить поисковый индекс



